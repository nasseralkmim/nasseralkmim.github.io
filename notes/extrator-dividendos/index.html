<!DOCTYPE html>
<html lang="en-us">

<head>
  <title>Extrator de dividendos | Nasser&#39;s personal website</title>

  <meta charset="UTF-8">
  <meta name="language" content="en">
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  
  

  <link rel="shortcut icon" type="image/png" href="/favicon.ico" />


  
  
    
 
  
  
  
  
  
  
    
    <link type="text/css" rel="stylesheet" href="/css/post.min.309cd3309cce8d5ddad2b3c35b1ff0fbb16e2917f9da734658765bb9e07a7e94.css" integrity="sha256-MJzTMJzOjV3a0rPDWx/w&#43;7FuKRf52nNGWHZbueB6fpQ="/>
  
    
    <link type="text/css" rel="stylesheet" href="/css/custom.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css" integrity="sha256-47DEQpj8HBSa&#43;/TImW&#43;5JCeuQeRkm5NMpJWZG3hSuFU="/>
  
  
   
   
    

<script type="application/ld+json">
  
    { 
      "@context": "http://schema.org", 
      "@type": "WebSite", 
      "url": "https:\/\/nasseralkmim.github.io\/notes\/extrator-dividendos\/",
      "name": "Extrator de dividendos",
      "author": {
        "@type": "Person",
        "name": ""
      },
      "description": ""
    }
  
  </script>
</head>

<body>
  <div class="burger__container">
  <div class="burger" aria-controls="navigation" aria-label="Menu">
    <div class="burger__meat burger__meat--1"></div>
    <div class="burger__meat burger__meat--2"></div>
    <div class="burger__meat burger__meat--3"></div>
  </div>
</div>
 

  <nav class="nav" id="navigation">
  <ul class="nav__list">
    
    
      <li>
        <a  href="/">home</a>
      </li>
    
      <li>
        <a  class="active"
         href="/notes">notes</a>
      </li>
    
  </ul>
</nav>


  <main>
    
    

    <div class="flex-wrapper">
      <div class="post__container">
        <div class="post">
          <header class="post__header">
            <h1 id="post__title">Extrator de dividendos</h1>
            <time datetime="2020-12-17 00:00:00 &#43;0000 UTC" class="post__date">Dec 17 2020</time> 
          </header>
          <article class="post__content">
              

<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
Objetivo
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<blockquote>
<p>Dado uma série de trades, saber quanto de dividendo foi recebido até então, separado por valores mensais.</p>
</blockquote>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
Resultado
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>Antecipando o resultado do artigo.
Se quiser acompanhar a lógica de solução o restante do texto mostra o processo.</p>
<div id="outline-container-headline-3" class="outline-4">
<h4 id="headline-3">
Input
</h4>
<div id="outline-text-headline-3" class="outline-text-4">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">trade_data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;trade_data.csv&#39;</span>, sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;;&#39;</span>, header<span style="color:#f92672">=</span>None)
<span style="color:#66d9ef">print</span>(trade_data)</code></pre></div>
</div>
<pre class="example">
            0     1      2   3     4
0  20-07-2020   buy  MGLU3  10  50,5
1  29-07-2020   buy  MGLU3  30    60
2  30-07-2020  sell  ITSA4  15    12
3  11-12-2019   buy  MGLU3  50    10
4  19-02-2020   buy  ITSA4  20    11
5  29-05-2020   buy  ITSA4  25    10
</pre>
</div>
</div>
<div id="outline-container-headline-4" class="outline-4">
<h4 id="headline-4">
Processar as negociações
</h4>
<div id="outline-text-headline-4" class="outline-text-4">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">trades <span style="color:#f92672">=</span> process_trades(trade_data_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;trade_data.csv&#39;</span>)
<span style="color:#66d9ef">print</span>(trades)</code></pre></div>
</div>
<pre class="example">
        date  type ticker  volume  price   total  vol_adj
0 2020-07-20   buy  MGLU3      10   50.5   505.0       10
1 2020-07-29   buy  MGLU3      30   60.0  1800.0       30
2 2020-07-30  sell  ITSA4      15   12.0  -180.0      -15
3 2019-11-12   buy  MGLU3      50   10.0   500.0       50
4 2020-02-19   buy  ITSA4      20   11.0   220.0       20
5 2020-05-29   buy  ITSA4      25   10.0   250.0       25
</pre>
</div>
</div>
<div id="outline-container-headline-5" class="outline-4">
<h4 id="headline-5">
Consolidação do portfólio
</h4>
<div id="outline-text-headline-5" class="outline-text-4">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">portfolio <span style="color:#f92672">=</span> consolidate_portfolio(trades)
<span style="color:#66d9ef">print</span>(portfolio)</code></pre></div>
</div>
<pre class="example">
        vol_liq  avg_price
ticker                    
ITSA4        30   9.666667
MGLU3        90  31.166667
</pre>
</div>
</div>
<div id="outline-container-headline-6" class="outline-4">
<h4 id="headline-6">
Proventos recebidos
</h4>
<div id="outline-text-headline-6" class="outline-text-4">
<div id="outline-container-headline-7" class="outline-6">
<h6 id="headline-7">
Formato tabela
</h6>
<div id="outline-text-headline-7" class="outline-text-6">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">dividends <span style="color:#f92672">=</span> consolidade_dividends(portfolio, trades)
<span style="color:#66d9ef">print</span>(dividends)</code></pre></div>
</div>
<pre class="example">
             date_com     value             type  vol_liq     total
    ticker                                                         
379 ITSA4  2020-02-28  0.020000        DIVIDENDO       20  0.400000
382 ITSA4  2020-02-20  0.226000        DIVIDENDO       20  4.520000
383 ITSA4  2020-02-20  0.217400  JRS CAP PROPRIO       20  4.348000
384 ITSA4  2020-05-29  0.020000        DIVIDENDO       45  0.900000
385 ITSA4  2020-08-31  0.020000        DIVIDENDO       30  0.600000
386 ITSA4  2020-11-30  0.020000        DIVIDENDO       30  0.600000
387 ITSA4  2020-08-17  0.020000        DIVIDENDO       30  0.600000
11  MGLU3  2019-12-30  0.035789  JRS CAP PROPRIO       50  1.789458
12  MGLU3  2020-07-30  0.094166        DIVIDENDO       90  8.474937
</pre>
</div>
</div>
<div id="outline-container-headline-8" class="outline-6">
<h6 id="headline-8">
Por ação
</h6>
<div id="outline-text-headline-8" class="outline-text-6">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(dividends<span style="color:#f92672">.</span>total<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;ticker&#39;</span>)<span style="color:#f92672">.</span>sum())
(dividends
 <span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;ticker&#39;</span>)[<span style="color:#e6db74">&#39;total&#39;</span>]
 <span style="color:#f92672">.</span>sum()
 <span style="color:#f92672">.</span>plot(
     kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bar&#39;</span>,
     ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Dividends R$&#39;</span>)
 )</code></pre></div>
</div>
<pre class="example">
ticker
ITSA4    11.968000
MGLU3    10.264395
Name: total, dtype: float64
</pre>
<p><img src="./jupyter/b1dad5477d065e76eaf89e89185188b76425768d.png" alt="./jupyter/b1dad5477d065e76eaf89e89185188b76425768d.png" title="./jupyter/b1dad5477d065e76eaf89e89185188b76425768d.png" /></p>
</div>
</div>
<div id="outline-container-headline-9" class="outline-6">
<h6 id="headline-9">
Por período
</h6>
<div id="outline-text-headline-9" class="outline-text-6">
<div id="outline-container-headline-10" class="outline-8">
<h8 id="headline-10">
A cada mês
</h8>
<div id="outline-text-headline-10" class="outline-text-8">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">(dividends
 <span style="color:#f92672">.</span>groupby(dividends<span style="color:#f92672">.</span>date_com<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>to_period(<span style="color:#e6db74">&#39;M&#39;</span>))[<span style="color:#e6db74">&#39;total&#39;</span>]
 <span style="color:#f92672">.</span>sum()
 <span style="color:#f92672">.</span>plot(kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bar&#39;</span>,
       xlabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Dates&#39;</span>,
       ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Dividends R$&#39;</span>)
 )</code></pre></div>
</div>
<p><img src="./jupyter/fd69254f813664635d65d12aa5d0211cb98da3c3.png" alt="./jupyter/fd69254f813664635d65d12aa5d0211cb98da3c3.png" title="./jupyter/fd69254f813664635d65d12aa5d0211cb98da3c3.png" /></p>
</div>
</div>
<div id="outline-container-headline-11" class="outline-8">
<h8 id="headline-11">
A cada mês incluindo meses sem recebimento
</h8>
<div id="outline-text-headline-11" class="outline-text-8">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">(dividends
<span style="color:#f92672">.</span>groupby(dividends<span style="color:#f92672">.</span>date_com<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>to_period(<span style="color:#e6db74">&#39;M&#39;</span>))[<span style="color:#e6db74">&#39;total&#39;</span>]
<span style="color:#f92672">.</span>sum()                          <span style="color:#75715e"># group by month period and sum</span>
<span style="color:#f92672">.</span>resample(<span style="color:#e6db74">&#39;M&#39;</span>)                  <span style="color:#75715e"># adds periods without data</span>
<span style="color:#f92672">.</span>sum()
<span style="color:#f92672">.</span>plot(kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bar&#39;</span>,
      xlabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Dates&#39;</span>,
      ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Dividends R$&#39;</span>)
)</code></pre></div>
</div>
<p><img src="./jupyter/c62efaac82957dba8f3db82b4af14f9892c087c6.png" alt="./jupyter/c62efaac82957dba8f3db82b4af14f9892c087c6.png" title="./jupyter/c62efaac82957dba8f3db82b4af14f9892c087c6.png" /></p>
</div>
</div>
<div id="outline-container-headline-12" class="outline-8">
<h8 id="headline-12">
A cada ano
</h8>
<div id="outline-text-headline-12" class="outline-text-8">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">(dividends
 <span style="color:#f92672">.</span>groupby(dividends<span style="color:#f92672">.</span>date_com<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>to_period(<span style="color:#e6db74">&#39;Y&#39;</span>))[<span style="color:#e6db74">&#39;total&#39;</span>]
 <span style="color:#f92672">.</span>sum()
 <span style="color:#f92672">.</span>plot(kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bar&#39;</span>,
       xlabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Dates&#39;</span>,
       ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Dividends R$&#39;</span>)
 )</code></pre></div>
</div>
<p><img src="./jupyter/4eec3ce720257278f8269fe6b54d70af9d029268.png" alt="./jupyter/4eec3ce720257278f8269fe6b54d70af9d029268.png" title="./jupyter/4eec3ce720257278f8269fe6b54d70af9d029268.png" /></p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-13" class="outline-2">
<h2 id="headline-13">
Estratégia global
</h2>
<div id="outline-text-headline-13" class="outline-text-2">
<div id="outline-container-headline-14" class="outline-4">
<h4 id="headline-14">
Portfolio consolidado
</h4>
<div id="outline-text-headline-14" class="outline-text-4">
<p>Para conseguir o portfolio consolidado:</p>
<ol>
<li>
<p>usar um banco banco de dados simples em CSV com data, tipo da ordem (buy, sell ou split), volume negociado e preço de compra médio da ordem. Nomear como <code class="verbatim">trade_data</code>.</p>
</li>
<li>
<p>carregar esse dado e consolidar o saldo atual da posição (considerando vendas, compras e split)</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-15" class="outline-4">
<h4 id="headline-15">
Eventos sociais
</h4>
<div id="outline-text-headline-15" class="outline-text-4">
<p>Para obter os dividendos e juros sobre capital próprio:</p>
<ol>
<li>
<p>usar base de dados da bolsa: <a href="http://bvmf.bmfbovespa.com.br/cias-listadas/empresas-listadas/ResumoProventosDinheiro.aspx?codigoCvm=10456&amp;tab=3.1&amp;idioma=pt-br">bmf-bovespa cia listadas</a>, extrair apenas os dividendos aprovados desde a data de início do portfolio até a data atual. Potencial problema: data de aprovação do dividendo é diferente da data de pagamento de fato. </p>
</li>
<li>
<p>usar o código da cvm para cada companhia: <a href="http://dados.cvm.gov.br/dataset/cia_aberta-cad">CVM dados cias abertas</a> </p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-16" class="outline-2">
<h2 id="headline-16">
Dados sobre as negociações
</h2>
<div id="outline-text-headline-16" class="outline-text-2">
<p>
Vamos iniciar com um portfolio imaginado compra e venda em datas diferentes.</p>
<div id="outline-container-headline-17" class="outline-4">
<h4 id="headline-17">
Input
</h4>
<div id="outline-text-headline-17" class="outline-text-4">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">trade_data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;trade_data.csv&#39;</span>, sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;;&#39;</span>, header<span style="color:#f92672">=</span>None)
<span style="color:#66d9ef">print</span>(trade_data)</code></pre></div>
</div>
<pre class="example">
            0     1      2   3     4
0  20-07-2020   buy  MGLU3  10  50,5
1  29-07-2020   buy  MGLU3  30    60
2  30-07-2020  sell  ITSA4  15    12
3  11-12-2019   buy  MGLU3  50    10
4  19-02-2020   buy  ITSA4  20    11
5  29-05-2020   buy  ITSA4  25    10
</pre>
<p>
Vamos fazer o seguinte:</p>
<ol>
<li>
<p>ler esse csv num dataframe</p>
</li>
<li>
<p>identificar a data conforme o registrado no banco de dados</p>
</li>
</ol>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd

trade_data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;trade_data.csv&#39;</span>, sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;;&#39;</span>,
                         names<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;date&#39;</span>, <span style="color:#e6db74">&#39;type&#39;</span>, <span style="color:#e6db74">&#39;ticker&#39;</span>, <span style="color:#e6db74">&#39;volume&#39;</span>, <span style="color:#e6db74">&#39;price&#39;</span>],
                         decimal<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;,&#39;</span>)
trade_data<span style="color:#f92672">.</span>date <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(trade_data<span style="color:#f92672">.</span>date, format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">-%m-%Y&#34;</span>)
<span style="color:#66d9ef">print</span>(trade_data)
<span style="color:#66d9ef">print</span>(trade_data<span style="color:#f92672">.</span>dtypes)</code></pre></div>
</div>
<pre class="example">
        date  type ticker  volume  price
0 2020-07-20   buy  MGLU3      10   50.5
1 2020-07-29   buy  MGLU3      30   60.0
2 2020-07-30  sell  ITSA4      15   12.0
3 2019-12-11   buy  MGLU3      50   10.0
4 2020-02-19   buy  ITSA4      20   11.0
5 2020-05-29   buy  ITSA4      25   10.0
date      datetime64[ns]
type              object
ticker            object
volume             int64
price            float64
dtype: object
</pre>
</div>
</div>
<div id="outline-container-headline-18" class="outline-4">
<h4 id="headline-18">
Detalhes sobre as negociações
</h4>
<div id="outline-text-headline-18" class="outline-text-4">
<p>
Criar um dataframe com detalhes das negociações</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">trades <span style="color:#f92672">=</span> trade_data<span style="color:#f92672">.</span>copy()

trades[<span style="color:#e6db74">&#39;total&#39;</span>] <span style="color:#f92672">=</span> trade_data<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: x<span style="color:#f92672">.</span>price <span style="color:#f92672">*</span> x<span style="color:#f92672">.</span>volume
                                           <span style="color:#66d9ef">if</span> x<span style="color:#f92672">.</span>type <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;buy&#39;</span>, <span style="color:#e6db74">&#39;split&#39;</span>]
                                           <span style="color:#66d9ef">else</span> <span style="color:#f92672">-</span> x<span style="color:#f92672">.</span>price <span style="color:#f92672">*</span> x<span style="color:#f92672">.</span>volume, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
trades[<span style="color:#e6db74">&#39;vol_adj&#39;</span>] <span style="color:#f92672">=</span> trade_data<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: x<span style="color:#f92672">.</span>volume
                                         <span style="color:#66d9ef">if</span> x<span style="color:#f92672">.</span>type <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;buy&#39;</span>, <span style="color:#e6db74">&#39;split&#39;</span>]
                                         <span style="color:#66d9ef">else</span>
                                         (<span style="color:#f92672">-</span>x<span style="color:#f92672">.</span>volume <span style="color:#66d9ef">if</span> x<span style="color:#f92672">.</span>type <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;sell&#39;</span>] <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>), axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
<span style="color:#66d9ef">print</span>(trades)</code></pre></div>
</div>
<pre class="example">
        date  type ticker  volume  price   total  vol_adj
0 2020-07-20   buy  MGLU3      10   50.5   505.0       10
1 2020-07-29   buy  MGLU3      30   60.0  1800.0       30
2 2020-07-30  sell  ITSA4      15   12.0  -180.0      -15
3 2019-12-11   buy  MGLU3      50   10.0   500.0       50
4 2020-02-19   buy  ITSA4      20   11.0   220.0       20
5 2020-05-29   buy  ITSA4      25   10.0   250.0       25
</pre>
</div>
</div>
<div id="outline-container-headline-19" class="outline-4">
<h4 id="headline-19">
Implementar função que processa as negociações
</h4>
<div id="outline-text-headline-19" class="outline-text-4">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_trades</span>(trade_data_file):
    trades <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(trade_data_file, sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;;&#39;</span>,
                         names<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;date&#39;</span>, <span style="color:#e6db74">&#39;type&#39;</span>,
                                <span style="color:#e6db74">&#39;ticker&#39;</span>, <span style="color:#e6db74">&#39;volume&#39;</span>,
                                <span style="color:#e6db74">&#39;price&#39;</span>],
                         decimal<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;,&#39;</span>,
                         parse_dates<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;date&#39;</span>])
    <span style="color:#75715e"># trades.date = pd.to_datetime(trade_data.date, format=&#34;%d-%m-%Y&#34;)</span>
    trades[<span style="color:#e6db74">&#39;total&#39;</span>] <span style="color:#f92672">=</span> trades<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: x<span style="color:#f92672">.</span>price <span style="color:#f92672">*</span> x<span style="color:#f92672">.</span>volume
					    <span style="color:#66d9ef">if</span> x<span style="color:#f92672">.</span>type <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;buy&#39;</span>, <span style="color:#e6db74">&#39;split&#39;</span>]
					    <span style="color:#66d9ef">else</span> <span style="color:#f92672">-</span> x<span style="color:#f92672">.</span>price <span style="color:#f92672">*</span> x<span style="color:#f92672">.</span>volume, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
    trades[<span style="color:#e6db74">&#39;vol_adj&#39;</span>] <span style="color:#f92672">=</span> trades<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: x<span style="color:#f92672">.</span>volume
					    <span style="color:#66d9ef">if</span> x<span style="color:#f92672">.</span>type <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;buy&#39;</span>, <span style="color:#e6db74">&#39;split&#39;</span>]
					    <span style="color:#66d9ef">else</span>
					    (<span style="color:#f92672">-</span>x<span style="color:#f92672">.</span>volume <span style="color:#66d9ef">if</span> x<span style="color:#f92672">.</span>type <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;sell&#39;</span>] <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>), axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">return</span> trades
<span style="color:#66d9ef">print</span>(process_trades(<span style="color:#e6db74">&#39;trade_data.csv&#39;</span>))</code></pre></div>
</div>
<pre class="example">
        date  type ticker  volume  price   total  vol_adj
0 2020-07-20   buy  MGLU3      10   50.5   505.0       10
1 2020-07-29   buy  MGLU3      30   60.0  1800.0       30
2 2020-07-30  sell  ITSA4      15   12.0  -180.0      -15
3 2019-11-12   buy  MGLU3      50   10.0   500.0       50
4 2020-02-19   buy  ITSA4      20   11.0   220.0       20
5 2020-05-29   buy  ITSA4      25   10.0   250.0       25
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-20" class="outline-2">
<h2 id="headline-20">
Consolidação do portfolio
</h2>
<div id="outline-text-headline-20" class="outline-text-2">
<p>Na consolidação o objetivo é obter os ativos com volume líquido atuais</p>
<p>
Custo médio que você pagou é útil para comparar com preço atual e saber se está ganhando ou perdendo considerando todos os trades.</p>
<div id="outline-container-headline-21" class="outline-4">
<h4 id="headline-21">
Desenvolvimento analítico
</h4>
<div id="outline-text-headline-21" class="outline-text-4">
<ol>
<li>
<p>se compra (ou split): volume x preço = total  compra</p>
</li>
<li>
<p>se venda: volume x preço = total  venda</p>
</li>
<li>
<p>volume líquido: volume compra - volume venda</p>
</li>
<li>
<p>preço médio = (total compra - total venda) / volume líquido</p>
</li>
</ol>
<img src="Consolidação_do_portfolio/2020-12-23_17-24-16_screenshot.png" alt="Consolidação_do_portfolio/2020-12-23_17-24-16_screenshot.png" title="Consolidação_do_portfolio/2020-12-23_17-24-16_screenshot.png" width="350px"/>
</div>
</div>
<div id="outline-container-headline-22" class="outline-4">
<h4 id="headline-22">
Protótipo
</h4>
<div id="outline-text-headline-22" class="outline-text-4">
<ol>
<li>
<p><code class="verbatim">groupby</code> para agrupar e consolidar o portfolio</p>
</li>
<li>
<p>dividir total pelo volume líquido para cada ticker</p>
</li>
</ol>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">portfolio <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
portfolio[<span style="color:#e6db74">&#39;vol_liq&#39;</span>] <span style="color:#f92672">=</span> trades<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;ticker&#39;</span>)[<span style="color:#e6db74">&#39;vol_adj&#39;</span>]<span style="color:#f92672">.</span>sum() 
portfolio[<span style="color:#e6db74">&#39;avg_price&#39;</span>] <span style="color:#f92672">=</span> trades<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;ticker&#39;</span>)[<span style="color:#e6db74">&#39;total&#39;</span>]<span style="color:#f92672">.</span>sum() <span style="color:#f92672">/</span> portfolio<span style="color:#f92672">.</span>vol_liq
<span style="color:#66d9ef">print</span>(portfolio)</code></pre></div>
</div>
<pre class="example">
        vol_liq  avg_price
ticker                    
ITSA4        30   9.666667
MGLU3        90  31.166667
</pre>
<p>
E se o volume líquido for zero, precisamos descartar essa linha usando um filtro no data frame.</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(portfolio[portfolio<span style="color:#f92672">.</span>vol_liq <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>])</code></pre></div>
</div>
<pre class="example">
        vol_liq  avg_price
ticker                    
ITSA4        30   9.666667
MGLU3        90  31.166667
</pre>
</div>
</div>
<div id="outline-container-headline-23" class="outline-4">
<h4 id="headline-23">
Implementar uma função de consolidação
</h4>
<div id="outline-text-headline-23" class="outline-text-4">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">consolidate_portfolio</span>(trades):
    portfolio <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
    portfolio[<span style="color:#e6db74">&#39;vol_liq&#39;</span>] <span style="color:#f92672">=</span> (trades
                            <span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;ticker&#39;</span>)[<span style="color:#e6db74">&#39;vol_adj&#39;</span>]
                            <span style="color:#f92672">.</span>sum()) 
    portfolio[<span style="color:#e6db74">&#39;avg_price&#39;</span>] <span style="color:#f92672">=</span> (trades
                              <span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;ticker&#39;</span>)[<span style="color:#e6db74">&#39;total&#39;</span>]
                              <span style="color:#f92672">.</span>sum() <span style="color:#f92672">/</span> portfolio<span style="color:#f92672">.</span>vol_liq)
    portfolio <span style="color:#f92672">=</span> portfolio[portfolio<span style="color:#f92672">.</span>vol_liq <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>]
    portfolio<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">&#39;portfolio.csv&#39;</span>)
    <span style="color:#66d9ef">return</span> portfolio
<span style="color:#66d9ef">print</span>(consolidate_portfolio(trades))</code></pre></div>
</div>
<pre class="example">
        vol_liq  avg_price
ticker                    
ITSA4        30   9.666667
MGLU3        90  31.166667
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-24" class="outline-2">
<h2 id="headline-24">
Código CVM das empresas
</h2>
<div id="outline-text-headline-24" class="outline-text-2">
<p>
Esses dados são baixados da própria CVM.
A <code class="verbatim">engine=c</code> não capta alguns formatos, usando <code class="verbatim">engine = &#39;python&#39;</code> capta.</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">cia_data_cvm <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;cad_cia_aberta.csv&#39;</span>, sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;;&#39;</span>, engine<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;python&#39;</span>)
<span style="color:#66d9ef">print</span>(cia_data_cvm<span style="color:#f92672">.</span>tail())
<span style="color:#66d9ef">print</span>(cia_data_cvm<span style="color:#f92672">.</span>columns)</code></pre></div>
</div>
<pre class="example">
                CNPJ_CIA                              DENOM_SOCIAL  \
2300  02.363.918/0001-20                    ZAIN PARTICIPAÇÕES S/A   
2301  71.320.931/0001-15                  ZANINI SA EQUIPS PESADOS   
2302  24.744.012/0001-99                          ZH OPERAÇÕES S/A   
2303  92.749.217/0001-17                         ZIVI SA CUTELARIA   
2304  74.533.787/0001-93  ZOGBI LEASING S/A ARRENDAMENTO MERCANTIL   

                DENOM_COMERC      DT_REG    DT_CONST   DT_CANCEL  \
2300  ZAIN PARTICIPAÇÕES S/A  1998-06-15  1998-01-19  2020-08-14   
2301                  ZANINI  1971-07-05         NaN  1997-01-27   
2302        ZH OPERAÇÕES S/A  2016-09-16  2016-04-15  2017-08-07   
2303                ZIVI S/A  1968-11-01  1931-01-01  2003-12-29   
2304           ZOGBI LEASING  1997-09-18  1993-06-18  2004-12-23   

                                         MOTIVO_CANCEL        SIT  DT_INI_SIT  \
2300                        ELISÃO POR EXTINÇÃO DA CIA  CANCELADA  2020-08-14   
2301          ATENDIMENTO AS NORMAS DA INSTR CVM 03/78  CANCELADA  1997-01-27   
2302            Cancelamento de ofício - IN CVM 480/09  CANCELADA  2017-08-07   
2303                           ELISÃO POR INCORPORAÇÃO  CANCELADA  2003-12-29   
2304  ATENDIMENTO AS NORMAS DA INSTRUÇÃO CVM Nº 361/02  CANCELADA  2004-12-23   

      CD_CVM  ... UF_RESP PAIS_RESP    CEP_RESP DDD_TEL_RESP    TEL_RESP  \
2300   17361  ...      RJ       NaN  22440033.0           21  21967200.0   
2301   11835  ...      SP       NaN   1013000.0           11   6424066.0   
2302   24007  ...      SP       NaN   4609005.0          011  50548989.0   
2303   11843  ...      RS       NaN  91030530.0           51  33585109.0   
2304   16462  ...     NaN       NaN   6029900.0           11  36814011.0   

     DDD_FAX_RESP    FAX_RESP                   EMAIL_RESP  \
2300         21.0  21967201.0        apsis.rj@apsis.com.br   
2301         11.0         NaN                          NaN   
2302          NaN         NaN  renno@setaatacadista.com.br   
2303         51.0  33585176.0   michael.ceitlin@gem.ind.br   
2304         11.0  36844630.0   4000.isola@bradesco.com.br   

            CNPJ_AUDITOR                                            AUDITOR  
2300  00.326.016/0001-99  TERCO AUDITORES INDEPENDENTES - SOCIEDADE SIMPLES  
2301  61.562.112/0001-20     PRICEWATERHOUSECOOPERS AUDITORES INDEPENDENTES  
2302  00.115.909/0001-95                     MS AUDITORES INDEPENDENTES S/C  
2303  61.562.112/0001-20     PRICEWATERHOUSECOOPERS AUDITORES INDEPENDENTES  
2304  57.755.217/0001-29                       KPMG AUDITORES INDEPENDENTES  

[5 rows x 46 columns]
Index([&#39;CNPJ_CIA&#39;, &#39;DENOM_SOCIAL&#39;, &#39;DENOM_COMERC&#39;, &#39;DT_REG&#39;, &#39;DT_CONST&#39;,
       &#39;DT_CANCEL&#39;, &#39;MOTIVO_CANCEL&#39;, &#39;SIT&#39;, &#39;DT_INI_SIT&#39;, &#39;CD_CVM&#39;,
       &#39;SETOR_ATIV&#39;, &#39;TP_MERC&#39;, &#39;CATEG_REG&#39;, &#39;DT_INI_CATEG&#39;, &#39;SIT_EMISSOR&#39;,
       &#39;DT_INI_SIT_EMISSOR&#39;, &#39;TP_ENDER&#39;, &#39;LOGRADOURO&#39;, &#39;COMPL&#39;, &#39;BAIRRO&#39;,
       &#39;MUN&#39;, &#39;UF&#39;, &#39;PAIS&#39;, &#39;CEP&#39;, &#39;DDD_TEL&#39;, &#39;TEL&#39;, &#39;DDD_FAX&#39;, &#39;FAX&#39;, &#39;EMAIL&#39;,
       &#39;TP_RESP&#39;, &#39;RESP&#39;, &#39;DT_INI_RESP&#39;, &#39;LOGRADOURO_RESP&#39;, &#39;COMPL_RESP&#39;,
       &#39;BAIRRO_RESP&#39;, &#39;MUN_RESP&#39;, &#39;UF_RESP&#39;, &#39;PAIS_RESP&#39;, &#39;CEP_RESP&#39;,
       &#39;DDD_TEL_RESP&#39;, &#39;TEL_RESP&#39;, &#39;DDD_FAX_RESP&#39;, &#39;FAX_RESP&#39;, &#39;EMAIL_RESP&#39;,
       &#39;CNPJ_AUDITOR&#39;, &#39;AUDITOR&#39;],
      dtype=&#39;object&#39;)
</pre>
<p>
Limitar o escopo do dataframe só ao que interessa. No final acessamos o código CVM com o CNPJ da empresa.</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">cia_code_cvm <span style="color:#f92672">=</span> cia_data_cvm[[<span style="color:#e6db74">&#39;CNPJ_CIA&#39;</span>, <span style="color:#e6db74">&#39;DENOM_SOCIAL&#39;</span>, <span style="color:#e6db74">&#39;CD_CVM&#39;</span>]]
<span style="color:#66d9ef">print</span>(cia_code_cvm)
<span style="color:#66d9ef">print</span>(cia_code_cvm<span style="color:#f92672">.</span>dtypes)</code></pre></div>
</div>
<pre class="example">
                CNPJ_CIA                                       DENOM_SOCIAL  \
0     08.773.135/0001-00                                    2W ENERGIA S.A.   
1     11.396.633/0001-87                        3A COMPANHIA SECURITIZADORA   
2     12.091.809/0001-55                       3R PETROLEUM OLÉO E GÁS S.A.   
3     01.547.749/0001-16  521 PARTICIPAÇOES S.A. - EM LIQUIDAÇÃO EXTRAJU...   
4     01.851.771/0001-55                               524 PARTICIPAÇOES SA   
...                  ...                                                ...   
2300  02.363.918/0001-20                             ZAIN PARTICIPAÇÕES S/A   
2301  71.320.931/0001-15                           ZANINI SA EQUIPS PESADOS   
2302  24.744.012/0001-99                                   ZH OPERAÇÕES S/A   
2303  92.749.217/0001-17                                  ZIVI SA CUTELARIA   
2304  74.533.787/0001-93           ZOGBI LEASING S/A ARRENDAMENTO MERCANTIL   

      CD_CVM  
0      25224  
1      21954  
2      25291  
3      16330  
4      16284  
...      ...  
2300   17361  
2301   11835  
2302   24007  
2303   11843  
2304   16462  

[2305 rows x 3 columns]
CNPJ_CIA        object
DENOM_SOCIAL    object
CD_CVM           int64
dtype: object
</pre>
</div>
</div>
<div id="outline-container-headline-25" class="outline-2">
<h2 id="headline-25">
CNPJ das empresa
</h2>
<div id="outline-text-headline-25" class="outline-text-2">
<p>
Para obter o cnpj associado a cada ticker usarei os dados desse site: <a href="https://www.infomoney.com.br/minhas-financas/confira-o-cnpj-das-acoes-negociadas-em-bolsa-e-saiba-como-declarar-no-imposto-de-renda/">https://www.infomoney.com.br/minhas-financas/confira-o-cnpj-das-acoes-negociadas-em-bolsa-e-saiba-como-declarar-no-imposto-de-renda/</a></p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://www.infomoney.com.br/minhas-financas/confira-o-cnpj-das-acoes-negociadas-em-bolsa-e-saiba-como-declarar-no-imposto-de-renda/&#39;</span>
cia_cnpj <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_html(url)[<span style="color:#ae81ff">0</span>]

<span style="color:#66d9ef">print</span>(cia_cnpj<span style="color:#f92672">.</span>head())
<span style="color:#66d9ef">print</span>(cia_cnpj<span style="color:#f92672">.</span>dtypes)
cia_cnpj<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">&#39;cia_cnpj.csv&#39;</span>) <span style="color:#75715e"># save to csv to avoid external dependency</span></code></pre></div>
</div>
<pre class="example">
  Nome de Pregão                                      Razão Social  \
0    ADVANCED-DH  ADVANCED DIGITAL HEALTH MEDICINA PREVENTIVA S.A.   
1    AES TIETE E                              AES TIETE ENERGIA SA   
2     AFLUENTE T      AFLUENTE TRANSMISSÃO DE ENERGIA ELÉTRICA S/A   
3       ALEF S/A                                         ALEF S.A.   
4   ALFA HOLDING                                ALFA HOLDINGS S.A.   

                 CNPJ                Código  
0  10.345.009/0001-98          ADHM1, ADHM3  
1  04.128.563/0001-10  TIET11, TIET3, TIET4  
2  10.338.320/0001-00                 AFLT3  
3  02.217.319/0001-07                ALEF3B  
4  17.167.396/0001-69   RPAD3, RPAD5, RPAD6  
Nome de Pregão    object
Razão Social      object
CNPJ              object
Código            object
dtype: object
</pre>
</div>
</div>
<div id="outline-container-headline-26" class="outline-2">
<h2 id="headline-26">
Portfolio com detalhes das companhias
</h2>
<div id="outline-text-headline-26" class="outline-text-2">
<div id="outline-container-headline-27" class="outline-4">
<h4 id="headline-27">
Estratégia
</h4>
<div id="outline-text-headline-27" class="outline-text-4">
<ol>
<li>
<p>usar o ticker das cias no portfolio consolidado para extrair o CNPJ</p>
</li>
<li>
<p>usar o CNPJ para extrair o código cvm</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-28" class="outline-4">
<h4 id="headline-28">
Protótipo
</h4>
<div id="outline-text-headline-28" class="outline-text-4">
<p>
Obter o CNPJ das cias no portfolio, usando método <code class="verbatim">isin()</code>.
Esse método testa se elementos na série está contido na lista passada como parâmetro.</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(portfolio<span style="color:#f92672">.</span>index<span style="color:#f92672">.</span>to_list())
<span style="color:#66d9ef">print</span>(cia_cnpj[cia_cnpj[<span style="color:#e6db74">&#39;Código&#39;</span>]<span style="color:#f92672">.</span>isin([<span style="color:#e6db74">&#39;MGLU3&#39;</span>, <span style="color:#e6db74">&#39;TIET3&#39;</span>, <span style="color:#e6db74">&#39;AFLT3&#39;</span>, <span style="color:#e6db74">&#39;ITSA3&#39;</span>])])</code></pre></div>
</div>
<pre class="example">
[&#39;ITSA4&#39;, &#39;MGLU3&#39;]
    Nome de Pregão                                  Razão Social  \
2       AFLUENTE T  AFLUENTE TRANSMISSÃO DE ENERGIA ELÉTRICA S/A   
260    MAGAZ LUIZA                           MAGAZINE LUIZA S.A.   

                   CNPJ Código  
2    10.338.320/0001-00  AFLT3  
260  47.960.950/0001-21  MGLU3  
</pre>
<p>
Se a cia tem mais de um ticker, fica mais complicado a pesquisa. Nesse caso é o uma string apenas.</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(cia_cnpj[<span style="color:#e6db74">&#39;Código&#39;</span>][<span style="color:#ae81ff">0</span>])
<span style="color:#66d9ef">print</span>(type(cia_cnpj[<span style="color:#e6db74">&#39;Código&#39;</span>][<span style="color:#ae81ff">0</span>]))</code></pre></div>
</div>
<pre class="example">
ADHM1, ADHM3
&lt;class &#39;str&#39;&gt;
</pre>
<p>
Podemos tentar usar o método <code class="verbatim">str.contains()</code>,</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(cia_cnpj[cia_cnpj[<span style="color:#e6db74">&#39;Código&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(<span style="color:#e6db74">&#39;ADHM1&#39;</span>)])</code></pre></div>
</div>
<pre class="example">
  Nome de Pregão                                      Razão Social  \
0    ADVANCED-DH  ADVANCED DIGITAL HEALTH MEDICINA PREVENTIVA S.A.   

                 CNPJ        Código  
0  10.345.009/0001-98  ADHM1, ADHM3  
</pre>
<p>
Mais de uma busca usando <code class="verbatim">|</code>,</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(cia_cnpj[cia_cnpj[<span style="color:#e6db74">&#39;Código&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(<span style="color:#e6db74">&#39;ADHM1|ITSA4|MGLU3&#39;</span>)])</code></pre></div>
</div>
<pre class="example">
    Nome de Pregão                                      Razão Social  \
0      ADVANCED-DH  ADVANCED DIGITAL HEALTH MEDICINA PREVENTIVA S.A.   
232         ITAUSA                    ITAUSA INVESTIMENTOS ITAU S.A.   
260    MAGAZ LUIZA                               MAGAZINE LUIZA S.A.   

                   CNPJ        Código  
0    10.345.009/0001-98  ADHM1, ADHM3  
232  61.532.644/0001-15  ITSA3, ITSA4  
260  47.960.950/0001-21         MGLU3  
</pre>
<p>
mas para passar uma lista de strings para essa função não funciona direto.
precisamos usar o método <code class="verbatim">join().</code></p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(cia_cnpj[cia_cnpj[<span style="color:#e6db74">&#39;Código&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(<span style="color:#e6db74">&#39;|&#39;</span><span style="color:#f92672">.</span>join([<span style="color:#e6db74">&#39;ADHM1&#39;</span>, <span style="color:#e6db74">&#39;ITSA4&#39;</span>, <span style="color:#e6db74">&#39;MGLU3&#39;</span>]))])</code></pre></div>
</div>
<pre class="example">
    Nome de Pregão                                      Razão Social  \
0      ADVANCED-DH  ADVANCED DIGITAL HEALTH MEDICINA PREVENTIVA S.A.   
232         ITAUSA                    ITAUSA INVESTIMENTOS ITAU S.A.   
260    MAGAZ LUIZA                               MAGAZINE LUIZA S.A.   

                   CNPJ        Código  
0    10.345.009/0001-98  ADHM1, ADHM3  
232  61.532.644/0001-15  ITSA3, ITSA4  
260  47.960.950/0001-21         MGLU3  
</pre>
<p>
Isso funciona bem.</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(portfolio<span style="color:#f92672">.</span>index)
<span style="color:#66d9ef">print</span>(cia_cnpj<span style="color:#f92672">.</span>CNPJ[cia_cnpj[<span style="color:#e6db74">&#39;Código&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(<span style="color:#e6db74">&#39;|&#39;</span><span style="color:#f92672">.</span>join(portfolio<span style="color:#f92672">.</span>index))]<span style="color:#f92672">.</span>values)
portfolio[<span style="color:#e6db74">&#39;cnpj&#39;</span>] <span style="color:#f92672">=</span> cia_cnpj<span style="color:#f92672">.</span>CNPJ[cia_cnpj[<span style="color:#e6db74">&#39;Código&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(<span style="color:#e6db74">&#39;|&#39;</span><span style="color:#f92672">.</span>join(portfolio<span style="color:#f92672">.</span>index))]<span style="color:#f92672">.</span>values 
<span style="color:#66d9ef">print</span>(portfolio)</code></pre></div>
</div>
<pre class="example">
Index([&#39;ITSA4&#39;, &#39;MGLU3&#39;], dtype=&#39;object&#39;, name=&#39;ticker&#39;)
[&#39;61.532.644/0001-15&#39; &#39;47.960.950/0001-21&#39;]
        vol_liq  avg_price                cnpj
ticker                                        
ITSA4        30   9.666667  61.532.644/0001-15
MGLU3        90  31.166667  47.960.950/0001-21
</pre>
<p>
Agora, pegar o código CVM com esse CNPJ.
Usarei a mesma técnica.</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(cia_code_cvm[cia_code_cvm[<span style="color:#e6db74">&#39;CNPJ_CIA&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(<span style="color:#e6db74">&#34;|&#34;</span><span style="color:#f92672">.</span>join(portfolio<span style="color:#f92672">.</span>cnpj))])
portfolio[<span style="color:#e6db74">&#39;cd_cvm&#39;</span>] <span style="color:#f92672">=</span> cia_code_cvm<span style="color:#f92672">.</span>CD_CVM[cia_code_cvm[<span style="color:#e6db74">&#39;CNPJ_CIA&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(<span style="color:#e6db74">&#34;|&#34;</span><span style="color:#f92672">.</span>join(portfolio<span style="color:#f92672">.</span>cnpj))]<span style="color:#f92672">.</span>values 
<span style="color:#66d9ef">print</span>(portfolio)</code></pre></div>
</div>
<pre class="example">
                CNPJ_CIA       DENOM_SOCIAL  CD_CVM
1319  61.532.644/0001-15        ITAUSA S.A.    7617
1436  47.960.950/0001-21  MAGAZINE LUIZA SA   22470
        vol_liq  avg_price                cnpj  cd_cvm
ticker                                                
ITSA4        30   9.666667  61.532.644/0001-15    7617
MGLU3        90  31.166667  47.960.950/0001-21   22470
</pre>
</div>
</div>
<div id="outline-container-headline-29" class="outline-4">
<h4 id="headline-29">
Implementar função que obtém detalhes das companhias
</h4>
<div id="outline-text-headline-29" class="outline-text-4">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_cia_details</span>(portfolio, cad_cia_file, cia_cnpj_file):
    cia_data_cvm <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(cad_cia_file,
                               sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;;&#39;</span>, engine<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;python&#39;</span>)
    cia_cnpj <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(cia_cnpj_file, sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;,&#39;</span>)
    pf_detail <span style="color:#f92672">=</span> portfolio<span style="color:#f92672">.</span>copy()
    pf_detail[<span style="color:#e6db74">&#39;cnpj&#39;</span>] <span style="color:#f92672">=</span> (cia_cnpj
                         <span style="color:#f92672">.</span>CNPJ[
                             cia_cnpj[<span style="color:#e6db74">&#39;Código&#39;</span>]
                             <span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(<span style="color:#e6db74">&#39;|&#39;</span><span style="color:#f92672">.</span>join(portfolio<span style="color:#f92672">.</span>index<span style="color:#f92672">.</span>to_list()))
                         ]<span style="color:#f92672">.</span>values)
    pf_detail[<span style="color:#e6db74">&#39;cd_cvm&#39;</span>] <span style="color:#f92672">=</span> (cia_data_cvm
                           <span style="color:#f92672">.</span>CD_CVM[
                               cia_data_cvm[<span style="color:#e6db74">&#39;CNPJ_CIA&#39;</span>]
                               <span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(<span style="color:#e6db74">&#34;|&#34;</span><span style="color:#f92672">.</span>join(pf_detail<span style="color:#f92672">.</span>cnpj))
                           ]<span style="color:#f92672">.</span>values)

    <span style="color:#66d9ef">return</span> pf_detail
pf_detail <span style="color:#f92672">=</span> get_cia_details(portfolio,
                     cad_cia_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;cad_cia_aberta.csv&#39;</span>,
                     cia_cnpj_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;cia_cnpj.csv&#39;</span>)
<span style="color:#66d9ef">print</span>(pf_detail)</code></pre></div>
</div>
<pre class="example">
        vol_liq  avg_price                cnpj  cd_cvm
ticker                                                
ITSA4        30   9.666667  61.532.644/0001-15    7617
MGLU3        90  31.166667  47.960.950/0001-21   22470
</pre>
<p>
Um rápido teste no <a href="http://bvmf.bmfbovespa.com.br/cias-listadas/empresas-listadas/ResumoProventosDinheiro.aspx?codigoCvm=7617&amp;tab=3.1&amp;idioma=pt-br">site</a> para confirmar o código.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-30" class="outline-2">
<h2 id="headline-30">
Proventos de cada companhia
</h2>
<div id="outline-text-headline-30" class="outline-text-2">
<div id="outline-container-headline-31" class="outline-4">
<h4 id="headline-31">
Estratégia
</h4>
<div id="outline-text-headline-31" class="outline-text-4">
<p>Aqui estou com dúvida se uso 1 dataframe para o provento de todas as companhias ou separo eles, 1 dataframe para cada empresa.
Acredito que separado fica mais organizado.</p>
<ol>
<li>
<p>usar o código CVM das ações no portfólio e obter um dataframe com os dados dos dividendos dessa ação, colocar num dictionary com key o ticker da ação e value o dataframe.</p>
</li>
<li>
<p>usar o dados de trade para saber quantas ações tinha na data da aprovação do dividendo</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-headline-32" class="outline-4">
<h4 id="headline-32">
Colocar os dados do site num dataframe
</h4>
<div id="outline-text-headline-32" class="outline-text-4">
<p>
Considerar primeiro apenas para MGLU3.
Quando for fazer para cada companhia do portfólio consolidado será necessário um loop.</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">cd_cvm <span style="color:#f92672">=</span> pf_detail<span style="color:#f92672">.</span>cd_cvm[<span style="color:#e6db74">&#39;MGLU3&#39;</span>] 
site <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#39;http://bvmf.bmfbovespa.com.br/cias-listadas/empresas-listadas/ResumoProventosDinheiro.aspx?codigoCvm={cd_cvm}&amp;tab=3.1&amp;idioma=pt-br&#39;</span>

proventos_data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_html(site, decimal<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;,&#39;</span>, thousands<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;.&#39;</span>)[<span style="color:#ae81ff">0</span>]
<span style="color:#66d9ef">print</span>(proventos_data<span style="color:#f92672">.</span>head())
<span style="color:#66d9ef">print</span>(proventos_data<span style="color:#f92672">.</span>dtypes)</code></pre></div>
</div>
<pre class="example">
  Tipo de Ativo Data da Aprovação (I)  Valor do Provento (R$)  \
0            ON            30/04/2012                0.014857   
1            ON            30/01/2014                0.065683   
2            ON            17/04/2014                0.107359   
3            ON            30/12/2014                0.078168   
4            ON            27/04/2015                0.109472   

   Proventos por unidade ou mil Tipo do Provento (II) Últ. Dia &#39;Com&#39;  \
0                             1             DIVIDENDO     30/04/2012   
1                             1       JRS CAP PROPRIO     20/02/2014   
2                             1             DIVIDENDO     22/04/2014   
3                             1       JRS CAP PROPRIO     14/01/2015   
4                             1             DIVIDENDO     27/04/2015   

  Data do Últ. Preço &#39;Com&#39; (III)  Últ. Preço &#39;Com&#39;  Preço por unidade ou mil  \
0                     30/04/2012             11.38                         1   
1                     20/02/2014              7.26                         1   
2                     22/04/2014              7.15                         1   
3                     14/01/2015              7.35                         1   
4                     27/04/2015              5.22                         1   

   Provento/Preço(%)  
0           0.130554  
1           0.904730  
2           1.501520  
3           1.063508  
4           2.097156  
Tipo de Ativo                      object
Data da Aprovação (I)              object
Valor do Provento (R$)            float64
Proventos por unidade ou mil        int64
Tipo do Provento (II)              object
Últ. Dia &#39;Com&#39;                     object
Data do Últ. Preço &#39;Com&#39; (III)     object
Últ. Preço &#39;Com&#39;                  float64
Preço por unidade ou mil            int64
Provento/Preço(%)                 float64
dtype: object
</pre>
</div>
</div>
<div id="outline-container-headline-33" class="outline-4">
<h4 id="headline-33">
Converter a data para o formato reconhecível
</h4>
<div id="outline-text-headline-33" class="outline-text-4">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">proventos <span style="color:#f92672">=</span> {}
proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>][<span style="color:#e6db74">&#39;valor&#39;</span>] <span style="color:#f92672">=</span> proventos_data[<span style="color:#e6db74">&#39;Valor do Provento (R$)&#39;</span>]
proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>][<span style="color:#e6db74">&#39;date_com&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(proventos_data[<span style="color:#e6db74">&#34;Últ. Dia &#39;Com&#39;&#34;</span>],
                                       format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">/%m/%Y&#34;</span>)
<span style="color:#66d9ef">print</span>(proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>])
<span style="color:#66d9ef">print</span>(proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>]<span style="color:#f92672">.</span>dtypes)</code></pre></div>
</div>
<pre class="example">
       valor   date_com
0   0.014857 2012-04-30
1   0.065683 2014-02-20
2   0.107359 2014-04-22
3   0.078168 2015-01-14
4   0.109472 2015-04-27
5   1.017261 2017-04-25
6   0.396103 2017-12-19
7   0.264465 2018-04-16
8   0.592705 2018-12-28
9   0.370260 2019-04-15
10  0.073607 2019-10-07
11  0.035789 2019-12-30
12  0.094166 2020-07-30
valor              float64
date_com    datetime64[ns]
dtype: object
</pre>
</div>
</div>
<div id="outline-container-headline-34" class="outline-4">
<h4 id="headline-34">
Descartar dados desnecessários
</h4>
<div id="outline-text-headline-34" class="outline-text-4">
<p>
Os proventos serão provisionados apenas quem possuía os papéis na data da aprovação.
Portanto, proventos antes da primeira compra não precisam ser armazenados.</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(trades<span style="color:#f92672">.</span>date[trades<span style="color:#f92672">.</span>ticker <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;MGLU3&#39;</span>]<span style="color:#f92672">.</span>min())
<span style="color:#66d9ef">print</span>(proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>])
<span style="color:#66d9ef">print</span>(proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>][proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>]<span style="color:#f92672">.</span>date_com <span style="color:#f92672">&gt;</span> trades<span style="color:#f92672">.</span>date[trades<span style="color:#f92672">.</span>ticker <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;MGLU3&#39;</span>]<span style="color:#f92672">.</span>min()])
proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>] <span style="color:#f92672">=</span> proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>][
    proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>]<span style="color:#f92672">.</span>date_com <span style="color:#f92672">&gt;</span> trades<span style="color:#f92672">.</span>date[trades<span style="color:#f92672">.</span>ticker <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;MGLU3&#39;</span>]<span style="color:#f92672">.</span>min()
]
<span style="color:#66d9ef">print</span>(proventos)</code></pre></div>
</div>
<pre class="example">
2019-12-11 00:00:00
       valor   date_com
0   0.014857 2012-04-30
1   0.065683 2014-02-20
2   0.107359 2014-04-22
3   0.078168 2015-01-14
4   0.109472 2015-04-27
5   1.017261 2017-04-25
6   0.396103 2017-12-19
7   0.264465 2018-04-16
8   0.592705 2018-12-28
9   0.370260 2019-04-15
10  0.073607 2019-10-07
11  0.035789 2019-12-30
12  0.094166 2020-07-30
       valor   date_com
11  0.035789 2019-12-30
12  0.094166 2020-07-30
{&#39;MGLU3&#39;:        valor   date_com
11  0.035789 2019-12-30
12  0.094166 2020-07-30}
</pre>
</div>
</div>
<div id="outline-container-headline-35" class="outline-4">
<h4 id="headline-35">
Considerações sobre ON e PN
</h4>
<div id="outline-text-headline-35" class="outline-text-4">
<p>
Se o ticker contiver 3 é ON e se contiver 4 é PN.</p>
</div>
</div>
<div id="outline-container-headline-36" class="outline-4">
<h4 id="headline-36">
Implementar função que obtém os dados dos proventos
</h4>
<div id="outline-text-headline-36" class="outline-text-4">
<p>
Função faz</p>
<ol>
<li>
<p>extrai os dados com base no url da BMF/BOVESPA</p>
</li>
<li>
<p>nomeia a coluna de data <code class="verbatim">&#39;date_com&#39;</code> e processa ela adequadamente</p>
</li>
</ol>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_dividends_data</span>(ticker, cd_cvm):
    site <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#39;http://bvmf.bmfbovespa.com.br/cias-listadas/empresas-listadas/ResumoProventosDinheiro.aspx?codigoCvm={cd_cvm}&amp;tab=3.1&amp;idioma=pt-br&#39;</span>

    dividends_data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_html(site,
                                  decimal<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;,&#39;</span>,
                                  thousands<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;.&#39;</span>,
                                  parse_dates<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;date_com&#39;</span>:[<span style="color:#e6db74">&#34;Últ. Dia &#39;Com&#39;&#34;</span>]}
                                  )[<span style="color:#ae81ff">0</span>]
    <span style="color:#66d9ef">return</span> dividends_data

<span style="color:#66d9ef">print</span>(get_dividends_data(<span style="color:#e6db74">&#39;MGLU3&#39;</span>, <span style="color:#ae81ff">22470</span>)<span style="color:#f92672">.</span>head())
<span style="color:#66d9ef">print</span>(get_dividends_data(<span style="color:#e6db74">&#39;MGLU3&#39;</span>, <span style="color:#ae81ff">22470</span>)<span style="color:#f92672">.</span>dtypes)</code></pre></div>
</div>
<pre class="example">
    date_com Tipo de Ativo Data da Aprovação (I)  Valor do Provento (R$)  \
0 2012-04-30            ON            30/04/2012                0.014857   
1 2014-02-20            ON            30/01/2014                0.065683   
2 2014-04-22            ON            17/04/2014                0.107359   
3 2015-01-14            ON            30/12/2014                0.078168   
4 2015-04-27            ON            27/04/2015                0.109472   

   Proventos por unidade ou mil Tipo do Provento (II)  \
0                             1             DIVIDENDO   
1                             1       JRS CAP PROPRIO   
2                             1             DIVIDENDO   
3                             1       JRS CAP PROPRIO   
4                             1             DIVIDENDO   

  Data do Últ. Preço &#39;Com&#39; (III)  Últ. Preço &#39;Com&#39;  Preço por unidade ou mil  \
0                     30/04/2012             11.38                         1   
1                     20/02/2014              7.26                         1   
2                     22/04/2014              7.15                         1   
3                     14/01/2015              7.35                         1   
4                     27/04/2015              5.22                         1   

   Provento/Preço(%)  
0           0.130554  
1           0.904730  
2           1.501520  
3           1.063508  
4           2.097156  
date_com                          datetime64[ns]
Tipo de Ativo                             object
Data da Aprovação (I)                     object
Valor do Provento (R$)                   float64
Proventos por unidade ou mil               int64
Tipo do Provento (II)                     object
Data do Últ. Preço &#39;Com&#39; (III)            object
Últ. Preço &#39;Com&#39;                         float64
Preço por unidade ou mil                   int64
Provento/Preço(%)                        float64
dtype: object
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-37" class="outline-2">
<h2 id="headline-37">
Provento recebido
</h2>
<div id="outline-text-headline-37" class="outline-text-2">
<p>Para cada provento aprovado, precisamos saber quantas ações constam nessa data.</p>
<img src="Proventos_recebidos/2020-12-23_17-22-54_screenshot.png" alt="Proventos_recebidos/2020-12-23_17-22-54_screenshot.png" title="Proventos_recebidos/2020-12-23_17-22-54_screenshot.png" width="350px"/>
<div id="outline-container-headline-38" class="outline-4">
<h4 id="headline-38">
Protótipo
</h4>
<div id="outline-text-headline-38" class="outline-text-4">
<p>
Obter volume líquido na data do provento.</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>]<span style="color:#f92672">.</span>date_com<span style="color:#f92672">.</span>tail(<span style="color:#ae81ff">1</span>))
<span style="color:#66d9ef">print</span>(trades)
<span style="color:#66d9ef">print</span>(trades<span style="color:#f92672">.</span>vol_adj[(trades<span style="color:#f92672">.</span>date <span style="color:#f92672">&lt;=</span> proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>]<span style="color:#f92672">.</span>date_com[<span style="color:#ae81ff">12</span>])
                         <span style="color:#f92672">&amp;</span> (trades<span style="color:#f92672">.</span>ticker <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;MGLU3&#39;</span>)]<span style="color:#f92672">.</span>sum())</code></pre></div>
</div>
<pre class="example">
12   2020-07-30
Name: date_com, dtype: datetime64[ns]
        date  type ticker  volume  price   total  vol_adj
0 2020-07-20   buy  MGLU3      10   50.5   505.0       10
1 2020-07-29   buy  MGLU3      30   60.0  1800.0       30
2 2020-07-30  sell  ITSA4      15   12.0  -180.0      -15
3 2019-12-11   buy  MGLU3      50   10.0   500.0       50
4 2020-02-19   buy  ITSA4      20   11.0   220.0       20
5 2020-05-29   buy  ITSA4      25   10.0   250.0       25
90
</pre>
</div>
</div>
<div id="outline-container-headline-39" class="outline-4">
<h4 id="headline-39">
Volume líquido para todas as datas de proventos
</h4>
<div id="outline-text-headline-39" class="outline-text-4">
<p>
O parâmetro <code class="verbatim">axis = 1</code> na função <code class="verbatim">apply()</code> é para indicar que vai ser aplicado linha a linha.</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>][<span style="color:#e6db74">&#39;vol_liq&#39;</span>] <span style="color:#f92672">=</span> proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>]<span style="color:#f92672">.</span>apply(
    <span style="color:#66d9ef">lambda</span> x: trades<span style="color:#f92672">.</span>vol_adj[
	(trades<span style="color:#f92672">.</span>date <span style="color:#f92672">&lt;=</span> x<span style="color:#f92672">.</span>date_com)
        <span style="color:#f92672">&amp;</span>
        (trades<span style="color:#f92672">.</span>ticker <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;MGLU3&#39;</span>)
    ]<span style="color:#f92672">.</span>sum(), 
    axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
<span style="color:#66d9ef">print</span>(proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>])</code></pre></div>
</div>
<pre class="example">
       valor   date_com  vol_liq
11  0.035789 2019-12-30       50
12  0.094166 2020-07-30       90
</pre>
</div>
</div>
<div id="outline-container-headline-40" class="outline-4">
<h4 id="headline-40">
Provento total
</h4>
<div id="outline-text-headline-40" class="outline-text-4">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>][<span style="color:#e6db74">&#39;total&#39;</span>] <span style="color:#f92672">=</span> proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>][<span style="color:#e6db74">&#39;valor&#39;</span>] <span style="color:#f92672">*</span> proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>][<span style="color:#e6db74">&#39;vol_liq&#39;</span>]
<span style="color:#66d9ef">print</span>(proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>])</code></pre></div>
</div>
<pre class="example">
       valor   date_com  vol_liq     total
11  0.035789 2019-12-30       50  1.789458
12  0.094166 2020-07-30       90  8.474937
</pre>
</div>
</div>
<div id="outline-container-headline-41" class="outline-4">
<h4 id="headline-41">
Plotar proventos no tempo
</h4>
<div id="outline-text-headline-41" class="outline-text-4">
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> matplotlib
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
matplotlib<span style="color:#f92672">.</span>style<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#39;seaborn&#39;</span>)
proventos[<span style="color:#e6db74">&#39;MGLU3&#39;</span>]<span style="color:#f92672">.</span>plot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;date_com&#39;</span>,
                        y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;total&#39;</span>,
                        kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bar&#39;</span>,
                        xlabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Data de aprovação&#39;</span>,
                        ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Valor R$&#39;</span>)</code></pre></div>
</div>
<p><img src="./jupyter/5624e1b9c6a8dfcba835feac44d152d5887a4b5a.png" alt="./jupyter/5624e1b9c6a8dfcba835feac44d152d5887a4b5a.png" title="./jupyter/5624e1b9c6a8dfcba835feac44d152d5887a4b5a.png" /></p>
</div>
</div>
<div id="outline-container-headline-42" class="outline-4">
<h4 id="headline-42">
Implementar função que processa os proventos
</h4>
<div id="outline-text-headline-42" class="outline-text-4">
<p>
Função faz:</p>
<ol>
<li>
<p>remove as data antigas, ou seja, quando não tinha nenhuma ação</p>
</li>
<li>
<p>filtra se ação é ON ou PN</p>
</li>
<li>
<p>adiciona ticker da ação como index</p>
</li>
<li>
<p>computa o volume liquido na última data &#39;COM&#39;</p>
</li>
<li>
<p>renomeia colunas</p>
</li>
<li>
<p>remove colunas indesejadas</p>
</li>
<li>
<p>calcula total dividendo por data do evento</p>
</li>
</ol>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_dividends</span>(ticker, trades, cd_cvm):
    dividends <span style="color:#f92672">=</span> get_dividends_data(ticker, cd_cvm)
    <span style="color:#75715e"># remove old unecessary data</span>
    dividends <span style="color:#f92672">=</span> dividends[
        dividends<span style="color:#f92672">.</span>date_com
        <span style="color:#f92672">&gt;=</span>
        trades<span style="color:#f92672">.</span>date[trades<span style="color:#f92672">.</span>ticker <span style="color:#f92672">==</span> ticker]<span style="color:#f92672">.</span>min()
    ]

    <span style="color:#75715e"># ON and PN</span>
    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;3&#39;</span> <span style="color:#f92672">in</span> ticker:
        dividends <span style="color:#f92672">=</span> dividends[dividends[<span style="color:#e6db74">&#39;Tipo de Ativo&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ON&#39;</span>]
    <span style="color:#66d9ef">elif</span> <span style="color:#e6db74">&#39;4&#39;</span> <span style="color:#f92672">in</span> ticker:
        dividends <span style="color:#f92672">=</span> dividends[dividends[<span style="color:#e6db74">&#39;Tipo de Ativo&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;PN&#39;</span>]

    <span style="color:#75715e"># add ticker as index</span>
    dividends <span style="color:#f92672">=</span> dividends<span style="color:#f92672">.</span>set_index(
	pd<span style="color:#f92672">.</span>Index([ticker] <span style="color:#f92672">*</span> dividends<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])<span style="color:#f92672">.</span>set_names([<span style="color:#e6db74">&#39;ticker&#39;</span>]),
	append<span style="color:#f92672">=</span>True
    )

    <span style="color:#75715e"># filter by date and ticker, then sum</span>
    dividends[<span style="color:#e6db74">&#39;vol_liq&#39;</span>] <span style="color:#f92672">=</span> dividends<span style="color:#f92672">.</span>apply(
	<span style="color:#66d9ef">lambda</span> x: trades<span style="color:#f92672">.</span>vol_adj[
	    (trades<span style="color:#f92672">.</span>date <span style="color:#f92672">&lt;=</span> x<span style="color:#f92672">.</span>date_com) <span style="color:#75715e"># in order to gain the dividends</span>
	    <span style="color:#f92672">&amp;</span>
	    (trades<span style="color:#f92672">.</span>ticker <span style="color:#f92672">==</span> ticker)
	]<span style="color:#f92672">.</span>sum(), 
	axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

    dividends <span style="color:#f92672">=</span> dividends<span style="color:#f92672">.</span>rename(
        columns<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;Valor do Provento (R$)&#39;</span>: <span style="color:#e6db74">&#39;value&#39;</span>,
                 <span style="color:#e6db74">&#39;Tipo do Provento (II)&#39;</span>: <span style="color:#e6db74">&#39;type&#39;</span>}
    )
    dividends <span style="color:#f92672">=</span> dividends[[<span style="color:#e6db74">&#39;date_com&#39;</span>, <span style="color:#e6db74">&#39;value&#39;</span>, <span style="color:#e6db74">&#39;type&#39;</span>, <span style="color:#e6db74">&#39;vol_liq&#39;</span>]]
    dividends[<span style="color:#e6db74">&#39;total&#39;</span>] <span style="color:#f92672">=</span> dividends<span style="color:#f92672">.</span>value <span style="color:#f92672">*</span> dividends<span style="color:#f92672">.</span>vol_liq

    <span style="color:#66d9ef">return</span> dividends
<span style="color:#66d9ef">print</span>(process_dividends(<span style="color:#e6db74">&#39;MGLU3&#39;</span>, trades, <span style="color:#ae81ff">22470</span>))</code></pre></div>
</div>
<pre class="example">
            date_com     value             type  vol_liq     total
   ticker                                                         
11 MGLU3  2019-12-30  0.035789  JRS CAP PROPRIO       50  1.789458
12 MGLU3  2020-07-30  0.094166        DIVIDENDO       90  8.474937
</pre>
</div>
</div>
<div id="outline-container-headline-43" class="outline-4">
<h4 id="headline-43">
Teste para ITSA4
</h4>
<div id="outline-text-headline-43" class="outline-text-4">
<img src="Provento_recebido/2020-12-24_00-12-58_screenshot.png" alt="Provento_recebido/2020-12-24_00-12-58_screenshot.png" title="Provento_recebido/2020-12-24_00-12-58_screenshot.png" width="350px"/>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(process_dividends(<span style="color:#e6db74">&#39;ITSA4&#39;</span>, trades, <span style="color:#ae81ff">7617</span>))</code></pre></div>
</div>
<pre class="example">
             date_com   value             type  vol_liq  total
    ticker                                                    
379 ITSA4  2020-02-28  0.0200        DIVIDENDO       20  0.400
382 ITSA4  2020-02-20  0.2260        DIVIDENDO       20  4.520
383 ITSA4  2020-02-20  0.2174  JRS CAP PROPRIO       20  4.348
384 ITSA4  2020-05-29  0.0200        DIVIDENDO       45  0.900
385 ITSA4  2020-08-31  0.0200        DIVIDENDO       30  0.600
386 ITSA4  2020-11-30  0.0200        DIVIDENDO       30  0.600
387 ITSA4  2020-08-17  0.0200        DIVIDENDO       30  0.600
</pre>
</div>
</div>
<div id="outline-container-headline-44" class="outline-4">
<h4 id="headline-44">
Implementar função que consolida os dividendos recebidos
</h4>
<div id="outline-text-headline-44" class="outline-text-4">
<p>
Função faz</p>
<ol>
<li>
<p>obtém os dividendos distribuídos por cada empresa no portfolio</p>
</li>
</ol>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">consolidade_dividends</span>(portfolio, trades):
    portfolio_details <span style="color:#f92672">=</span> get_cia_details(portfolio, <span style="color:#e6db74">&#39;cad_cia_aberta.csv&#39;</span>, <span style="color:#e6db74">&#39;cia_cnpj.csv&#39;</span>)
    dividends <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()

    <span style="color:#66d9ef">for</span> [ticker, cd_cvm] <span style="color:#f92672">in</span> zip(portfolio_details<span style="color:#f92672">.</span>index, portfolio_details<span style="color:#f92672">.</span>cd_cvm):
        dividends <span style="color:#f92672">=</span> dividends<span style="color:#f92672">.</span>append(process_dividends(ticker, trades, cd_cvm))
    <span style="color:#66d9ef">return</span> dividends
<span style="color:#66d9ef">print</span>(consolidade_dividends(portfolio, trades))</code></pre></div>
</div>
<pre class="example">
             date_com     value             type  vol_liq     total
    ticker                                                         
379 ITSA4  2020-02-28  0.020000        DIVIDENDO       20  0.400000
382 ITSA4  2020-02-20  0.226000        DIVIDENDO       20  4.520000
383 ITSA4  2020-02-20  0.217400  JRS CAP PROPRIO       20  4.348000
384 ITSA4  2020-05-29  0.020000        DIVIDENDO       45  0.900000
385 ITSA4  2020-08-31  0.020000        DIVIDENDO       30  0.600000
386 ITSA4  2020-11-30  0.020000        DIVIDENDO       30  0.600000
387 ITSA4  2020-08-17  0.020000        DIVIDENDO       30  0.600000
11  MGLU3  2019-12-30  0.035789  JRS CAP PROPRIO       50  1.789458
12  MGLU3  2020-07-30  0.094166        DIVIDENDO       90  8.474937
</pre>
</div>
</div>
</div>
</div>


              
                  

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script>
              
          </article>
          

<ul class="tags__list">
    
    <li class="tag__item">
        <a class="tag__link" href="https://nasseralkmim.github.io/tags/finance/">finance</a>
    </li>
    <li class="tag__item">
        <a class="tag__link" href="https://nasseralkmim.github.io/tags/data-analysis/">data-analysis</a>
    </li></ul>

 <div class="pagination">
  
    <a class="pagination__item" href="https://nasseralkmim.github.io/notes/fed-monetary-mechanism/">
        <span class="pagination__label">Previous Post</span>
        <span class="pagination__title">How does monetary policy gets transmited to the economy?</span>
    </a>
  

  
    <a class="pagination__item" href="https://nasseralkmim.github.io/notes/books-2020/">
      <span class="pagination__label">Next Post</span>
      <span class="pagination__title" >2020 Books review</span>
    </a>
  
</div>

          <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "nasseralkmim" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          <footer class="post__footer">
            


<div class="social-icons">
  
     
    
      <a class="social-icons__link" rel="me" title="Email"
         href="mailto:nasser.alkmim@gmail.com"
         target="_blank" rel="noopener">
        <div class="social-icons__icon" style="background-image: url('https://nasseralkmim.github.io/svg/email.svg')"></div>
      </a>
    
  
     
    
      <a class="social-icons__link" rel="me" title="LinkedIn"
         href="https://www.linkedin.com/in/nasser-alkmim-300882a6/"
         target="_blank" rel="noopener">
        <div class="social-icons__icon" style="background-image: url('https://nasseralkmim.github.io/svg/linkedin.svg')"></div>
      </a>
    
  
     
    
      <a class="social-icons__link" rel="me" title="GitHub"
         href="https://github.com/nasseralkmim"
         target="_blank" rel="noopener">
        <div class="social-icons__icon" style="background-image: url('https://nasseralkmim.github.io/svg/github.svg')"></div>
      </a>
    
  
     
    
      <a class="social-icons__link" rel="me" title="Instagram"
         href="https://instagram.com/naszr"
         target="_blank" rel="noopener">
        <div class="social-icons__icon" style="background-image: url('https://nasseralkmim.github.io/svg/instagram.svg')"></div>
      </a>
    
     
</div>

            <p>© 2021</p>
          </footer>
          </div>
      </div>
      
      <div class="toc-container">
           <div class="toc-post-title">Extrator de dividendos</div> 
        <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">Objetivo</a>
</li>
<li><a href="#headline-2">Resultado</a>
<ul>
<li><a href="#headline-3">Input</a>
</li>
<li><a href="#headline-4">Processar as negociações</a>
</li>
<li><a href="#headline-5">Consolidação do portfólio</a>
</li>
<li><a href="#headline-6">Proventos recebidos</a>
<ul>
<li><a href="#headline-7">Formato tabela</a>
</li>
<li><a href="#headline-8">Por ação</a>
</li>
<li><a href="#headline-9">Por período</a>
<ul>
<li><a href="#headline-10">A cada mês</a>
</li>
<li><a href="#headline-11">A cada mês incluindo meses sem recebimento</a>
</li>
<li><a href="#headline-12">A cada ano</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#headline-13">Estratégia global</a>
<ul>
<li><a href="#headline-14">Portfolio consolidado</a>
</li>
<li><a href="#headline-15">Eventos sociais</a>
</li>
</ul>
</li>
<li><a href="#headline-16">Dados sobre as negociações</a>
<ul>
<li><a href="#headline-17">Input</a>
</li>
<li><a href="#headline-18">Detalhes sobre as negociações</a>
</li>
<li><a href="#headline-19">Implementar função que processa as negociações</a>
</li>
</ul>
</li>
<li><a href="#headline-20">Consolidação do portfolio</a>
<ul>
<li><a href="#headline-21">Desenvolvimento analítico</a>
</li>
<li><a href="#headline-22">Protótipo</a>
</li>
<li><a href="#headline-23">Implementar uma função de consolidação</a>
</li>
</ul>
</li>
<li><a href="#headline-24">Código CVM das empresas</a>
</li>
<li><a href="#headline-25">CNPJ das empresa</a>
</li>
<li><a href="#headline-26">Portfolio com detalhes das companhias</a>
<ul>
<li><a href="#headline-27">Estratégia</a>
</li>
<li><a href="#headline-28">Protótipo</a>
</li>
<li><a href="#headline-29">Implementar função que obtém detalhes das companhias</a>
</li>
</ul>
</li>
<li><a href="#headline-30">Proventos de cada companhia</a>
<ul>
<li><a href="#headline-31">Estratégia</a>
</li>
<li><a href="#headline-32">Colocar os dados do site num dataframe</a>
</li>
<li><a href="#headline-33">Converter a data para o formato reconhecível</a>
</li>
<li><a href="#headline-34">Descartar dados desnecessários</a>
</li>
<li><a href="#headline-35">Considerações sobre ON e PN</a>
</li>
<li><a href="#headline-36">Implementar função que obtém os dados dos proventos</a>
</li>
</ul>
</li>
<li><a href="#headline-37">Provento recebido</a>
<ul>
<li><a href="#headline-38">Protótipo</a>
</li>
<li><a href="#headline-39">Volume líquido para todas as datas de proventos</a>
</li>
<li><a href="#headline-40">Provento total</a>
</li>
<li><a href="#headline-41">Plotar proventos no tempo</a>
</li>
<li><a href="#headline-42">Implementar função que processa os proventos</a>
</li>
<li><a href="#headline-43">Teste para ITSA4</a>
</li>
<li><a href="#headline-44">Implementar função que consolida os dividendos recebidos</a>
</li>
</ul>
</li>
</ul>
</nav>
      </div>
      
    </div>
    

  </main>

   

  
  <script src="/js/index.min.49e4d8a384357d9b445b87371863419937ede9fa77737522ffb633073aebfa44.js" integrity="sha256-SeTYo4Q1fZtEW4c3GGNBmTft6fp3c3Ui/7YzBzrr&#43;kQ=" crossorigin="anonymous"></script>
  
  
  

  
  
  

  
    <script src="/js/table-of-contents.js"></script>
  


</body>

</html>
